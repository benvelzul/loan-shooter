<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Top-Down Shooter - Pause, Fix & Restored Specials</title>
    <style>
      html, body { margin: 0; padding: 0; height: 100%; background: #0d0f13; color: #e6edf3; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; user-select: none; overflow: hidden; }
      #gameCanvas { display: block; width: 100vw; height: 100vh; background: radial-gradient(1200px 1200px at 50% 40%, #141925 0%, #0d0f13 60%); }
      .hud { position: fixed; left: 0; top: 0; width: 100vw; padding: 12px 16px; box-sizing: border-box; display: flex; align-items: center; gap: 16px; pointer-events: none; }
      .pill { pointer-events: none; background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12); border-radius: 999px; padding: 8px 12px; font-size: 14px; line-height: 1; }
      .hpbar { display: flex; align-items: center; gap: 8px; min-width: 220px; }
      .hpbar .track { flex: 1; height: 12px; background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12); border-radius: 999px; overflow: hidden; }
      .hpbar .fill { height: 100%; background: linear-gradient(90deg, #34d399, #10b981); width: 50%; }
      .centerOverlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(6,8,12,.65); backdrop-filter: blur(4px); }
      .centerOverlay.show { display: flex; }
      .card { width: min(960px, 94vw); background: #0f1320; border: 1px solid rgba(255,255,255,.12); border-radius: 14px; padding: 20px; box-shadow: 0 20px 60px rgba(0,0,0,.45); }
      .card h2 { margin: 0 0 12px 0; font-weight: 700; letter-spacing: .3px; }
      .upgradeRow { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
      .upgradeBtn { background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); border: 1px solid rgba(255,255,255,.16); border-radius: 12px; padding: 12px; text-align: left; cursor: pointer; transition: transform 120ms ease, background 120ms ease, border-color 120ms ease; display: flex; gap: 12px; align-items: center; }
      .upgradeBtn:hover { transform: translateY(-2px); background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06)); border-color: rgba(255,255,255,.28); }
      .upIcon { width: 36px; height: 36px; border-radius: 8px; display: grid; place-items: center; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); flex: 0 0 auto; }
      .upText { display: grid; gap: 4px; }
      .upText h3 { margin: 0; font-size: 16px; }
      .upText p { margin: 0; font-size: 13px; color: #b7c0cc; }
      .upBadge { margin-left: auto; font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid; background: rgba(255,255,255,.06); }
      .rarity-common{ border-color:#3b82f633!important; } .rarity-uncommon{ border-color:#22c55e55!important; } .rarity-rare{ border-color:#a855f766!important; } .rarity-legendary{ border-color:#f59e0b77!important; background:linear-gradient(180deg,rgba(245,158,11,.12),rgba(245,158,11,.06)); }
      .badge-common{ color:#93c5fd;border-color:#3b82f6; } .badge-uncommon{ color:#86efac;border-color:#22c55e; } .badge-rare{ color:#d8b4fe;border-color:#a855f7; } .badge-legendary{ color:#fcd34d;border-color:#f59e0b; }
      .footerRow { display:flex; gap:10px; margin-top:12px; }
      .actionBtn { cursor:pointer; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); color:#e6edf3; }
      .actionBtn[disabled]{ opacity:.5; cursor:not-allowed; }
      .statsGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px; margin-top: 8px; font-size: 14px; }
      .statsGrid div { display: flex; justify-content: space-between; border-bottom: 1px dashed rgba(255,255,255,.08); padding: 4px 0; }
      .hidden { display: none !important; }
    </style>
  </head>
  <body>
    <canvas id="gameCanvas"></canvas>

    <div class="hud">
      <div class="hpbar pill">
        <span>HP</span>
        <div class="track"><div class="fill" id="hpFill"></div></div>
        <span id="hpText">100/100</span>
      </div>
      <div class="pill" id="weaponText">Weapon: Basic</div>
      <div class="pill" id="ammoText" class="hidden">Ammo: -</div>
      <div class="pill" id="roundText">Round 1</div>
      <div class="pill" id="killsText">Kills 0</div>
      <div class="pill" id="scoreText">Score 0</div>
      <div class="pill" style="margin-left:auto">WASD: Move · Arrows: Shoot · Space: Dash · Esc/P: Pause</div>
    </div>

    <div class="centerOverlay" id="upgradeOverlay">
      <div class="card">
        <h2 id="upgradeTitle">Choose an upgrade</h2>
        <div class="upgradeRow" id="upgradeRow"></div>
        <div class="footerRow">
          <button id="rerollBtn" class="actionBtn">Reroll (3)</button>
          <button id="skipBtn" class="actionBtn">Skip</button>
          <span id="footerInfo" style="opacity:.8;font-size:12px;align-self:center"></span>
        </div>
      </div>
    </div>

    <div class="centerOverlay" id="pauseOverlay">
      <div class="card">
        <h2>Paused</h2>
        <div id="statsGrid" class="statsGrid"></div>
        <div class="footerRow">
          <button id="resumeBtn" class="actionBtn">Resume</button>
        </div>
      </div>
    </div>

    <div class="centerOverlay" id="gameOverOverlay">
      <div class="card">
        <h2 id="gameOverTitle">Game Over</h2>
        <p id="finalStats" style="margin: 8px 0 14px 0; color:#b7c0cc"></p>
        <div class="footerRow">
          <button id="restartBtn" class="actionBtn">Restart</button>
          <button id="continueBtn" class="actionBtn hidden">Continue</button>
        </div>
      </div>
    </div>

    <script>
      // Utils
      function clamp(v,min,max){return Math.max(min,Math.min(max,v));}
      function randRange(min,max){return Math.random()*(max-min)+min;}
      function sample(a,c){const p=a.slice(),o=[];while(o.length<c&&p.length)o.push(p.splice(Math.floor(Math.random()*p.length),1)[0]);return o;}
      function distance(a,b){const dx=a.x-b.x,dy=a.y-b.y;return Math.hypot(dx,dy);}
      function angleBetween(a,b){return Math.atan2(b.y-a.y,b.x-a.x);}
      function wrapAngle(a){while(a<=-Math.PI)a+=Math.PI*2;while(a>Math.PI)a-=Math.PI*2;return a;}

      // Canvas
      const canvas=document.getElementById('gameCanvas'); const ctx=canvas.getContext('2d');
      function resize(){const dpr=Math.max(1,window.devicePixelRatio||1);canvas.width=Math.floor(canvas.clientWidth*dpr);canvas.height=Math.floor(canvas.clientHeight*dpr);ctx.setTransform(dpr,0,0,dpr,0,0);} window.addEventListener('resize',resize); resize();

      // HUD & overlays
      const hpFillEl=document.getElementById('hpFill'), hpTextEl=document.getElementById('hpText'), roundTextEl=document.getElementById('roundText'), killsTextEl=document.getElementById('killsText'), scoreTextEl=document.getElementById('scoreText'), weaponTextEl=document.getElementById('weaponText'), ammoTextEl=document.getElementById('ammoText');
      const upgradeOverlay=document.getElementById('upgradeOverlay'), upgradeRow=document.getElementById('upgradeRow'), upgradeTitle=document.getElementById('upgradeTitle'), footerInfo=document.getElementById('footerInfo'), rerollBtn=document.getElementById('rerollBtn'), skipBtn=document.getElementById('skipBtn');
      const pauseOverlay=document.getElementById('pauseOverlay'), statsGrid=document.getElementById('statsGrid'), resumeBtn=document.getElementById('resumeBtn');
      const gameOverOverlay=document.getElementById('gameOverOverlay'), gameOverTitle=document.getElementById('gameOverTitle'), finalStats=document.getElementById('finalStats'), restartBtn=document.getElementById('restartBtn'), continueBtn=document.getElementById('continueBtn');

      // State
      const keysDown=new Set();
      let world={state:'menu',time:0,round:1,score:0,totalKills:0,endlessMode:false,bossRoundActive:false,screenShake:0,timeScale:1.0,timeScaleTimer:0,soundEnabled:true};
      
      // Sound system using Web Audio API
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      
      function playSound(frequency, duration, type='sine', volume=0.1) {
        if (!world.soundEnabled) return;
        try {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
          oscillator.type = type;
          
          gainNode.gain.setValueAtTime(0, audioContext.currentTime);
          gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
          gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
          
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + duration);
        } catch(e) {
          // Fallback for browsers that don't support Web Audio API
        }
      }
      
      function playShootSound(weaponType) {
        switch(weaponType) {
          case 'basic': playSound(800, 0.1, 'square', 0.05); break;
          case 'pistol': playSound(600, 0.15, 'sawtooth', 0.06); break;
          case 'shotgun': playSound(400, 0.3, 'sawtooth', 0.08); break;
          case 'railgun': playSound(1200, 0.4, 'sine', 0.07); break;
          case 'katana': playSound(1000, 0.2, 'triangle', 0.06); break;
        }
      }
      
      function playHitSound() {
        playSound(300, 0.1, 'square', 0.04);
      }
      
      function playEnemyDeathSound(enemyType) {
        switch(enemyType) {
          case 'boss': playSound(200, 0.8, 'sawtooth', 0.1); break;
          case 'teleporter': playSound(900, 0.3, 'sine', 0.06); break;
          case 'splitter': playSound(700, 0.4, 'triangle', 0.07); break;
          default: playSound(400, 0.2, 'square', 0.05); break;
        }
      }
      
      function playPickupSound() {
        playSound(1200, 0.2, 'sine', 0.06);
      }
      
      function playDashSound() {
        playSound(600, 0.15, 'triangle', 0.04);
      }
      
      function playUpgradeSound() {
        playSound(800, 0.3, 'sine', 0.08);
      }
      
      function playSpecialAbilitySound(ability) {
        switch(ability) {
          case 'shield': playSound(1000, 0.5, 'triangle', 0.07); break;
          case 'timeFreeze': playSound(500, 1.0, 'sine', 0.08); break;
          case 'energyBlast': playSound(1500, 0.6, 'sawtooth', 0.09); break;
          case 'heal': playSound(800, 0.4, 'sine', 0.06); break;
        }
      }
      const player={
        x:canvas.clientWidth/2,y:canvas.clientHeight/2,radius:14,color:'#5eead4',
        velocityX:0,velocityY:0,maxHp:100,hp:100,
        baseMoveSpeed:240,dashSpeed:640,isDashing:false,dashTime:0,dashDuration:0.16,dashCooldown:2.6,dashCooldownTimer:0,
        fireRate:5,fireCooldown:0,bulletSpeed:520,bulletDamage:16,bulletRadius:5,
        baseBulletLife:2.2,bulletLifeMultiplier:1.0,homingStrength:0,
        pierceCount:0,bounceCount:0,multiShot:0,spreadDeg:10,critChance:0.05,critMultiplier:1.5,pickupRadius:80,
        luckLevel:0, weaponType:'basic', invulnTime:0, specialAbility:'none', specialCooldown:0,
        weapon:{magazineSize:12,magazine:12,reloadTime:1.2, reloadTimer:0,reloading:false, pellets:7,pelletSpreadDeg:34,pelletLife:0.6, katanaCooldown:0.35,katanaCooldownTimer:0,katanaRange:86,katanaArcDeg:100,katanaDamage:42},
        mods:{
          bulletFireLevel:0,bulletPoisonLevel:0,katanaFireLevel:0,katanaPoisonLevel:0,
          fasterReload:false,biggerMag:false,choke:false,doubleBarrel:false,slug:false,swiftSlash:false,extendedReach:false,
          pistolDoubleTap:false,shotgunKnockback:false,katanaWhirl:false,railChain:false,rocketCluster:false
        }
      };
      const enemies=[], bullets=[], pickups=[], particles=[], trails=[];
      let onKillExplosionEnabled=false, rocketExplosionScale=1;

      // Screen effects
      function addScreenShake(intensity=8){world.screenShake=Math.max(world.screenShake,intensity);}
      function setTimeScale(scale,duration=0.3){world.timeScale=scale;setTimeout(()=>world.timeScale=1.0,duration*1000);}

      // Icons
      function icon(name){const s='currentColor';switch(name){
        case'heart':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 21s-7-4.5-9-8 0-7 4-7 5 3 5 3 1-3 5-3 6 3 4 7-9 8-9 8z" stroke="'+s+'" stroke-width="1.5"/></svg>';
        case'plus':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="'+s+'" stroke-width="1.8"/></svg>';
        case'boot':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M6 18h12M7 14l3 4m7-4-3 4" stroke="'+s+'" stroke-width="1.5"/></svg>';
        case'rate':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 12h4m3 0h9" stroke="'+s+'" stroke-width="2"/><path d="M8 12c0-4 2-6 4-6s4 2 4 6-2 6-4 6-4-2-4-6z" stroke="'+s+'" stroke-width="1.2"/></svg>';
        case'arrow':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 12h12M10 6l6 6-6 6" stroke="'+s+'" stroke-width="1.8"/></svg>';
        case'timer':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="13" r="7" stroke="'+s+'" stroke-width="1.4"/><path d="M9 4h6M12 8v5" stroke="'+s+'" stroke-width="1.4"/></svg>';
        case'damage':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 2l3 6 7 1-5 5 1 7-6-3-6 3 1-7-5-5 7-1 3-6z" stroke="'+s+'" stroke-width="1.2"/></svg>';
        case'bullet':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M8 6h8v12H8z" stroke="'+s+'" stroke-width="1.5"/><path d="M12 6V2" stroke="'+s+'" stroke-width="1.5"/></svg>';
        case'pierce':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 12h18" stroke="'+s+'" stroke-width="1.8"/><circle cx="12" cy="12" r="2.5" stroke="'+s+'" stroke-width="1.2"/></svg>';
        case'bounce':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 17c4-6 7 2 10-4s5 2 8-4" stroke="'+s+'" stroke-width="1.5"/></svg>';
        case'multi':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M5 12h14M5 8h10M5 16h10" stroke="'+s+'" stroke-width="1.6"/></svg>';
        case'spread':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 12h6m0 0 8-6m-8 6 8 6" stroke="'+s+'" stroke-width="1.4"/></svg>';
        case'crit':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 3l3 6 7 1-5 5 1 7-6-3-6 3 1-7-5-5 7-1 3-6z" stroke="'+s+'" stroke-width="1.2"/></svg>';
        case'magnet':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M7 7v4a5 5 0 0 0 10 0V7M7 7h4M13 7h4" stroke="'+s+'" stroke-width="1.5"/></svg>';
        case'dash':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 12h10M10 6l8 6-8 6" stroke="'+s+'" stroke-width="1.8"/></svg>';
        case'boom':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 2v5M4 7l4 2M20 7l-4 2M5 17l3-2m8 0 3 2M12 10l2 4-4 0 2-4z" stroke="'+s+'" stroke-width="1.2"/></svg>';
        case'pistol':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 10h12l3 3H9l-2 2H4z" stroke="'+s+'" stroke-width="1.4"/></svg>';
        case'shotgun':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 12h14l4 2-2 2H9l-2-2" stroke="'+s+'" stroke-width="1.4"/></svg>';
        case'katana':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 18l10-10 2 2-10 10H4zM14 8l4-4" stroke="'+s+'" stroke-width="1.3"/></svg>';
        case'rail':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 12h12M7 8h10M7 16h10" stroke="'+s+'" stroke-width="1.6"/></svg>';
        case'rocket':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M5 15l4 4m6-14l4 4-6 6-4-4 6-6z" stroke="'+s+'" stroke-width="1.3"/></svg>';
        case'fire':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 3c2 3-2 4 0 7 2 2 5 3 2 7-2 2-6 1-7-2-1-3 1-5 3-6" stroke="'+s+'" stroke-width="1.3"/></svg>';
        case'poison':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 2v4m-3 4h6m-8 4h10m-8 4h6" stroke="'+s+'" stroke-width="1.3"/><circle cx="9" cy="10" r="1" fill="'+s+'"/><circle cx="15" cy="10" r="1" fill="'+s+'"/></svg>';
        case'star':return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 3l3 6 7 1-5 5 1 7-6-3-6 3 1-7-5-5 7-1 3-6z" stroke="'+s+'" stroke-width="1.2"/></svg>';
        default:return'<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="8" stroke="'+s+'" stroke-width="1.2"/></svg>';
      }}

      // Rarities & luck
      const RARITY={COMMON:'common',UNCOMMON:'uncommon',RARE:'rare',LEGENDARY:'legendary'};
      const baseRarityWeights={common:.5,uncommon:.3,rare:.15,legendary:.05};
      function getEffectiveRarityWeights(){const L=player.luckLevel||0,m={common:Math.max(.1,1-.12*L),uncommon:1+.08*L,rare:1+.06*L,legendary:1+.04*L},w={common:baseRarityWeights.common*m.common,uncommon:baseRarityWeights.uncommon*m.uncommon,rare:baseRarityWeights.rare*m.rare,legendary:baseRarityWeights.legendary*m.legendary},s=w.common+w.uncommon+w.rare+w.legendary;return{common:w.common/s,uncommon:w.uncommon/s,rare:w.rare/s,legendary:w.legendary/s};}
      function rollRarity(){const w=getEffectiveRarityWeights(),o=[RARITY.COMMON,RARITY.UNCOMMON,RARITY.RARE,RARITY.LEGENDARY];const r=Math.random();let a=0;for(const k of o){a+=w[k];if(r<a)return k;}return RARITY.COMMON;}
      function rarityLabel(r){return r[0].toUpperCase()+r.slice(1);}

      // Reset
      function resetGame(){
        Object.assign(world,{state:'playing',round:1,totalKills:0,score:0,time:0,upgradesTaken:0,scoreUpgradeStep:1000,nextScoreUpgradeAt:1000,pendingBonusUpgrades:0,bossRoundActive:false,endlessMode:false,rerolls:3});
        enemies.length=bullets.length=pickups.length=particles.length=0; onKillExplosionEnabled=false; rocketExplosionScale=1;
        Object.assign(player,{x:canvas.clientWidth/2,y:canvas.clientHeight/2,velocityX:0,velocityY:0,maxHp:100,hp:100,baseMoveSpeed:240,dashSpeed:640,isDashing:false,dashTime:0,dashDuration:0.16,dashCooldown:2.6,dashCooldownTimer:0, fireRate:5,fireCooldown:0,bulletSpeed:520,bulletDamage:16,bulletRadius:5, baseBulletLife:2.2,bulletLifeMultiplier:1.0,homingStrength:0, pierceCount:0,bounceCount:0,multiShot:0,spreadDeg:10,critChance:0.05,critMultiplier:1.5,pickupRadius:80,luckLevel:0,weaponType:'basic'});
        Object.assign(player.weapon,{magazineSize:12,magazine:12,reloadTime:1.2,reloadTimer:0,reloading:false,pellets:7,pelletSpreadDeg:34,pelletLife:0.6,katanaCooldown:0.35,katanaCooldownTimer:0,katanaRange:86,katanaArcDeg:100,katanaDamage:42});
        Object.assign(player.mods,{bulletFireLevel:0,bulletPoisonLevel:0,katanaFireLevel:0,katanaPoisonLevel:0,fasterReload:false,biggerMag:false,choke:false,doubleBarrel:false,slug:false,swiftSlash:false,extendedReach:false,pistolDoubleTap:false,shotgunKnockback:false,katanaWhirl:false,railChain:false,rocketCluster:false});
        updateHud(); startRound();
      }

      // Upgrades
      const stateUpgrades={
        luck:{name:'Luck',icon:'star',values:{common:null,uncommon:{lv:2},rare:{lv:3},legendary:{lv:4}},apply:v=>{player.luckLevel+=v.lv;},desc:v=>`Better upgrade odds (+${v.lv} Luck).`,compatible:()=>true},
        range:{name:'Range',icon:'timer',values:{common:{pct:.15},uncommon:{pct:.30},rare:{pct:.50},legendary:{pct:.80}},apply:v=>{player.bulletLifeMultiplier*=1+v.pct;},desc:v=>`+${Math.round(v.pct*100)}% bullet lifetime.`,compatible:()=>player.weaponType!=='katana'},
        homing:{name:'Homing Shots',icon:'arrow',values:{common:null,uncommon:{rad:1.4},rare:{rad:2.2},legendary:{rad:3.6}},apply:v=>{player.homingStrength+=v.rad;},desc:v=>`Shots home (turn ${Math.round(v.rad*57.3)}°/s).`,compatible:()=>player.weaponType!=='katana'},
        hp_up:{name:'Vitality',icon:'heart',values:{common:{maxHp:1.10,heal:.10},uncommon:{maxHp:1.20,heal:.20},rare:{maxHp:1.35,heal:.30},legendary:{maxHp:1.50,heal:.40}},apply:v=>{player.maxHp=Math.round(player.maxHp*v.maxHp);player.hp=clamp(player.hp+Math.round(player.maxHp*v.heal),0,player.maxHp);},desc:v=>`+${Math.round((v.maxHp-1)*100)}% max HP, heal ${Math.round(v.heal*100)}%.`,compatible:()=>true},
        heal:{name:'Field Medic',icon:'plus',values:{common:{heal:.30},uncommon:{heal:.45},rare:{heal:.65},legendary:{heal:.90}},apply:v=>{player.hp=clamp(player.hp+Math.round(player.maxHp*v.heal),0,player.maxHp);},desc:v=>`Heal ${Math.round(v.heal*100)}% max HP.`,compatible:()=>true},
        speed:{name:'Agility',icon:'boot',values:{common:{pct:.10},uncommon:{pct:.15},rare:{pct:.22},legendary:{pct:.30}},apply:v=>{player.baseMoveSpeed*=1+v.pct;},desc:v=>`+${Math.round(v.pct*100)}% move speed.`,compatible:()=>true},
        firerate:{name:'Rapid Fire',icon:'rate',values:{common:{pct:.10},uncommon:{pct:.20},rare:{pct:.30},legendary:{pct:.45}},apply:v=>{player.fireRate*=1+v.pct;},desc:v=>`+${Math.round(v.pct*100)}% fire rate.`,compatible:()=>player.weaponType!=='katana'},
        proj_speed:{name:'Accelerated Rounds',icon:'arrow',values:{common:{pct:.10},uncommon:{pct:.20},rare:{pct:.35},legendary:{pct:.50}},apply:v=>{player.bulletSpeed*=1+v.pct;},desc:v=>`+${Math.round(v.pct*100)}% projectile speed.`,compatible:()=>player.weaponType!=='katana'},
        damage:{name:'High Caliber',icon:'damage',values:{common:{pct:.15},uncommon:{pct:.25},rare:{pct:.40},legendary:{pct:.60}},apply:v=>{player.bulletDamage*=1+v.pct;},desc:v=>`+${Math.round(v.pct*100)}% bullet damage.`,compatible:()=>player.weaponType!=='katana'},
        bullet_size:{name:'Heavy Bullets',icon:'bullet',values:{common:{pct:.10},uncommon:{pct:.20},rare:{pct:.30},legendary:{pct:.45}},apply:v=>{player.bulletRadius*=1+v.pct;},desc:v=>`+${Math.round(v.pct*100)}% bullet size.`,compatible:()=>player.weaponType!=='katana'},
        spread_up:{name:'Wide Spread',icon:'spread',values:{common:{deg:+6},uncommon:{deg:+10},rare:{deg:+14},legendary:{deg:+20}},apply:v=>{player.spreadDeg+=v.deg;},desc:v=>`+${v.deg}° spread.`,compatible:()=>player.weaponType!=='katana'},
        spread_down:{name:'Tight Spread',icon:'spread',values:{common:{deg:-4},uncommon:{deg:-6},rare:{deg:-8},legendary:{deg:-12}},apply:v=>{player.spreadDeg=Math.max(0,player.spreadDeg+v.deg);},desc:v=>`${v.deg}° spread.`,compatible:()=>player.weaponType!=='katana'},
        crit_chance:{name:'Sharpshooter',icon:'crit',values:{common:{pct:.05},uncommon:{pct:.10},rare:{pct:.15},legendary:{pct:.25}},apply:v=>{player.critChance=Math.min(.95,player.critChance+v.pct);},desc:v=>`+${Math.round(v.pct*100)}% crit chance.`,compatible:()=>player.weaponType!=='katana'},
        crit_damage:{name:'Headshot',icon:'crit',values:{common:{pct:.25},uncommon:{pct:.50},rare:{pct:.75},legendary:{pct:1.20}},apply:v=>{player.critMultiplier+=v.pct;},desc:v=>`+${Math.round(v.pct*100)}% crit damage.`,compatible:()=>player.weaponType!=='katana'},
        pickup:{name:'Magnet',icon:'magnet',values:{common:{pct:.30},uncommon:{pct:.50},rare:{pct:.80},legendary:{pct:1.20}},apply:v=>{player.pickupRadius*=1+v.pct;},desc:v=>`+${Math.round(v.pct*100)}% pickup radius.`,compatible:()=>true},
        dash_cd:{name:'Afterburners',icon:'dash',values:{common:{pct:.15},uncommon:{pct:.30},rare:{pct:.40},legendary:{pct:.55}},apply:v=>{player.dashCooldown*=1-v.pct;},desc:v=>`-${Math.round(v.pct*100)}% dash cooldown.`,compatible:()=>true},
      };
      const fixedUpgrades=[
        {id:'pierce',name:'Piercing',icon:'pierce',rarity:RARITY.UNCOMMON,desc:'+1 projectile pierce.',apply:()=>{player.pierceCount+=1;},compatible:()=>player.weaponType!=='katana'},
        {id:'bounce',name:'Ricochet',icon:'bounce',rarity:RARITY.RARE,desc:'+1 projectile bounce.',apply:()=>{player.bounceCount+=1;},compatible:()=>player.weaponType!=='katana'},
        {id:'multishot',name:'Multishot',icon:'multi',rarity:RARITY.RARE,desc:'+1 projectile (slows fire slightly).',apply:()=>{player.multiShot+=1;},compatible:()=>player.weaponType!=='katana'},
        {id:'on_kill_boom',name:'Shrapnel',icon:'boom',rarity:RARITY.RARE,desc:'Enemies explode on death.',apply:()=>{onKillExplosionEnabled=true;},compatible:()=>true},
      ];

      // Weapons and Legendary upgrades
      const baseWeapons=[
        {id:'w_pistol',name:'Pistol',icon:'pistol',rarity:RARITY.LEGENDARY,desc:'15-round mag, reloads. High damage.',apply:()=>selectWeapon('pistol')},
        {id:'w_shotgun',name:'Shotgun',icon:'shotgun',rarity:RARITY.LEGENDARY,desc:'7-pellet blast. Slow, heavy burst.',apply:()=>selectWeapon('shotgun')},
        {id:'w_katana',name:'Katana',icon:'katana',rarity:RARITY.LEGENDARY,desc:'Close-range slash arc.',apply:()=>selectWeapon('katana')},
        {id:'w_rail',name:'Railgun',icon:'rail',rarity:RARITY.LEGENDARY,desc:'Fast, piercing beam shot.',apply:()=>selectWeapon('railgun')},
        {id:'w_rocket',name:'Rocket Launcher',icon:'rocket',rarity:RARITY.LEGENDARY,desc:'Explosive rockets.',apply:()=>selectWeapon('rocket')},
      ];
      const weaponUpgradesByType={
        pistol:[
          {id:'wu_bigmag',name:'Bigger Magazine',icon:'pistol',rarity:RARITY.LEGENDARY,desc:'+50% magazine size.',apply:()=>{player.weapon.magazineSize=Math.round(player.weapon.magazineSize*1.5);player.weapon.magazine=player.weapon.magazineSize;player.mods.biggerMag=true;}},
          {id:'wu_fastreload',name:'Quick Reload',icon:'pistol',rarity:RARITY.LEGENDARY,desc:'-30% reload time.',apply:()=>{player.weapon.reloadTime*=0.7;player.mods.fasterReload=true;}},
          {id:'wu_pois',name:'Poison Rounds',icon:'poison',rarity:RARITY.LEGENDARY,desc:'Bullets apply poison DoT.',apply:()=>{player.mods.bulletPoisonLevel+=1;}},
          {id:'wu_fire',name:'Incendiary Rounds',icon:'fire',rarity:RARITY.LEGENDARY,desc:'Bullets apply burning DoT.',apply:()=>{player.mods.bulletFireLevel+=1;}},
          {id:'wu_pistol_dt',name:'Double Tap',icon:'pistol',rarity:RARITY.LEGENDARY,desc:'25% chance to fire an extra shot.',apply:()=>{player.mods.pistolDoubleTap=true;}},
        ],
        shotgun:[
          {id:'wu_choke',name:'Choke',icon:'shotgun',rarity:RARITY.LEGENDARY,desc:'-35% spread.',apply:()=>{player.weapon.pelletSpreadDeg*=0.65;player.mods.choke=true;}},
          {id:'wu_double',name:'Double Barrel',icon:'shotgun',rarity:RARITY.LEGENDARY,desc:'+50% pellets, slower fire.',apply:()=>{player.weapon.pellets=Math.max(1,Math.round(player.weapon.pellets*1.5));player.mods.doubleBarrel=true;}},
          {id:'wu_slug',name:'Slug Rounds',icon:'shotgun',rarity:RARITY.LEGENDARY,desc:'Fewer pellets, high dmg, longer range.',apply:()=>{player.weapon.pellets=Math.max(1,Math.round(player.weapon.pellets*0.5));player.weapon.pelletSpreadDeg*=0.5;player.weapon.pelletLife*=1.6;player.bulletDamage*=1.5;player.mods.slug=true;}},
          {id:'wu_fire',name:'Dragon’s Breath',icon:'fire',rarity:RARITY.LEGENDARY,desc:'Pellets apply burning DoT.',apply:()=>{player.mods.bulletFireLevel+=1;}},
          {id:'wu_knock',name:'Concussive Blast',icon:'shotgun',rarity:RARITY.LEGENDARY,desc:'Pellets knock enemies back.',apply:()=>{player.mods.shotgunKnockback=true;}},
        ],
        katana:[
          {id:'wu_k_fire',name:'Fire Katana',icon:'fire',rarity:RARITY.LEGENDARY,desc:'Slashes ignite enemies.',apply:()=>{player.mods.katanaFireLevel+=1;}},
          {id:'wu_k_pois',name:'Poison Edge',icon:'poison',rarity:RARITY.LEGENDARY,desc:'Slashes poison enemies.',apply:()=>{player.mods.katanaPoisonLevel+=1;}},
          {id:'wu_k_reach',name:'Extended Reach',icon:'katana',rarity:RARITY.LEGENDARY,desc:'+25% slash range.',apply:()=>{player.weapon.katanaRange=Math.round(player.weapon.katanaRange*1.25);player.mods.extendedReach=true;}},
          {id:'wu_k_swift',name:'Swift Slash',icon:'katana',rarity:RARITY.LEGENDARY,desc:'-25% slash cooldown.',apply:()=>{player.weapon.katanaCooldown*=0.75;player.mods.swiftSlash=true;}},
          {id:'wu_k_whirl',name:'Whirlwind',icon:'katana',rarity:RARITY.LEGENDARY,desc:'Dashing damages nearby enemies.',apply:()=>{player.mods.katanaWhirl=true;}},
        ],
        railgun:[
          {id:'wu_rail_over',name:'Overcharge',icon:'rail',rarity:RARITY.LEGENDARY,desc:'+35% damage.',apply:()=>{player.bulletDamage*=1.35;}},
          {id:'wu_rail_cap',name:'Capacitors',icon:'rail',rarity:RARITY.LEGENDARY,desc:'+25% fire rate.',apply:()=>{player.fireRate*=1.25;}},
          {id:'wu_rail_chain',name:'Chain Arc',icon:'rail',rarity:RARITY.LEGENDARY,desc:'Hits chain to nearby enemies.',apply:()=>{player.mods.railChain=true;}},
        ],
        rocket:[
          {id:'wu_rock_boom',name:'Bigger Boom',icon:'rocket',rarity:RARITY.LEGENDARY,desc:'+25% radius & damage.',apply:()=>{rocketExplosionScale*=1.25;}},
          {id:'wu_rock_fuse',name:'Quick Fuse',icon:'rocket',rarity:RARITY.LEGENDARY,desc:'+20% proj speed & fire rate.',apply:()=>{player.bulletSpeed*=1.2;player.fireRate*=1.2;}},
          {id:'wu_rock_cluster',name:'Cluster Bombs',icon:'rocket',rarity:RARITY.LEGENDARY,desc:'Explosions split into mini blasts.',apply:()=>{player.mods.rocketCluster=true;}},
        ],
      };

      // Compatibility & choice building
      function makeStateVariant(key,rarity){const u=stateUpgrades[key],v=u.values[rarity];if(!v)return null;return{id:`${key}_${rarity}`,baseId:key,name:u.name,icon:u.icon,rarity,desc:u.desc(v),apply:()=>u.apply(v),compatible:u.compatible};}
      const katanaIncompatible=new Set(['range','homing','firerate','proj_speed','damage','bullet_size','spread_up','spread_down','crit_chance','crit_damage','pierce','bounce','multishot']);
      function isCompatible(up){if(player.weaponType==='katana'){const base=up.baseId||up.id;if(katanaIncompatible.has(base))return false;}return up.compatible?up.compatible():true;}
      function buildNormalChoices(){const out=[],used=new Set();let guard=0;while(out.length<3&&guard++<100){const r=rollRarity();const pool=[];for(const k of Object.keys(stateUpgrades)){const v=makeStateVariant(k,r);if(v&&isCompatible(v))pool.push(v);}for(const fu of fixedUpgrades)if(fu.rarity===r&&isCompatible(fu))pool.push(fu);if(!pool.length)continue;const pick=pool[Math.floor(Math.random()*pool.length)];const base=pick.baseId||pick.id;if(used.has(base))continue;used.add(base);out.push(pick);}while(out.length<3){const v=makeStateVariant('speed',RARITY.COMMON);if(v&&!out.find(c=>(c.baseId||c.id)===(v.baseId||v.id)))out.push(v);else break;}return out;}

      // Upgrade UI with reroll + skip
      let currentOfferMode={type:'normal',title:null,onPick:null};
      function setFooter(){rerollBtn.textContent=`Reroll (${world.rerolls})`;rerollBtn.disabled=world.rerolls<=0;footerInfo.textContent=currentOfferMode.type==='bonus'?'Bonus upgrade (Score)':'';}
      function offersForCurrentMode(){ if(currentOfferMode.type==='weapon') return sample(baseWeapons,3); if(currentOfferMode.type==='weaponUpgrade'){const pool=weaponUpgradesByType[player.weaponType]||[]; return pool.length?sample(pool,Math.min(3,pool.length)):buildNormalChoices();} return buildNormalChoices(); }
      function regenerateOffers(){
        upgradeRow.innerHTML='';
        const offers=offersForCurrentMode();
        for(const up of offers){
          const rarity=up.rarity||RARITY.COMMON;
          const btn=document.createElement('button'); btn.className=`upgradeBtn rarity-${rarity}`;
          btn.innerHTML=`<div class="upIcon">${icon(up.icon)}</div><div class="upText"><h3>${up.name}</h3><p>${up.desc}</p></div><span class="upBadge badge-${rarity}">${rarityLabel(rarity)}</span>`;
          btn.onclick=()=>currentOfferMode.onPick(up);
          upgradeRow.appendChild(btn);
        }
        setFooter();
      }
      function presentUpgradeChoices(opts={forceNormal:false,title:null,modeOverride:null}){
        // Decide mode
        if(!opts.forceNormal && ((world.upgradesTaken+1)%5===0)){
          if(player.weaponType==='basic'){currentOfferMode.type='weapon'; currentOfferMode.title='Choose a weapon';}
          else {currentOfferMode.type='weaponUpgrade'; currentOfferMode.title='Choose a weapon upgrade';}
        }else{
          currentOfferMode.type=opts.modeOverride || 'normal';
          currentOfferMode.title=opts.title||'Choose an upgrade';
        }
        upgradeTitle.textContent=currentOfferMode.title;

        currentOfferMode.onPick=(up)=>{
          up.apply();
          if(currentOfferMode.type==='bonus'){
            world.pendingBonusUpgrades=Math.max(0,world.pendingBonusUpgrades-1);
            closeUpgradeOverlay();
            if(world.pendingBonusUpgrades>0){ presentBonusUpgrade(); }
            else { world.state='playing'; }
          }else{
            world.upgradesTaken+=1;
            closeUpgradeOverlay();
            world.state='playing';
            startRound();
          }
          updateHud();
        };

        rerollBtn.onclick=()=>{if(world.rerolls<=0)return;world.rerolls-=1;regenerateOffers();};
        skipBtn.onclick=()=>{
          if(currentOfferMode.type==='bonus'){world.pendingBonusUpgrades=Math.max(0,world.pendingBonusUpgrades-1);}
          else {world.upgradesTaken+=1;}
          closeUpgradeOverlay();
          if(currentOfferMode.type==='bonus' && world.pendingBonusUpgrades>0){presentBonusUpgrade();}
          else {world.state='playing'; startRound();}
        };

        regenerateOffers(); openUpgradeOverlay();
      }
      function presentBonusUpgrade(){
        currentOfferMode.onPick=(up)=>{
          up.apply();
          if(currentOfferMode.type==='bonus'){
            world.pendingBonusUpgrades=Math.max(0,world.pendingBonusUpgrades-1);
            closeUpgradeOverlay();
            if(world.pendingBonusUpgrades>0){ presentBonusUpgrade(); }
            else { world.state='playing'; }
          }else{
            world.upgradesTaken+=1;
            closeUpgradeOverlay();
            world.state='playing';
            startRound();
          }
          updateHud();
        };

        rerollBtn.onclick=()=>{if(world.rerolls<=0)return;world.rerolls-=1;regenerateOffers();};
        skipBtn.onclick=()=>{
          if(currentOfferMode.type==='bonus'){world.pendingBonusUpgrades=Math.max(0,world.pendingBonusUpgrades-1);}
          else {world.upgradesTaken+=1;}
          closeUpgradeOverlay();
          if(currentOfferMode.type==='bonus' && world.pendingBonusUpgrades>0){presentBonusUpgrade();}
          else {world.state='playing';}
        };
        world.state='choosing';
        currentOfferMode={type:'bonus',title:'Bonus upgrade (Score)'};
        upgradeTitle.textContent=currentOfferMode.title;
        regenerateOffers(); openUpgradeOverlay();
      }
      function openUpgradeOverlay(){upgradeOverlay.classList.add('show');}
      function closeUpgradeOverlay(){upgradeOverlay.classList.remove('show');}

      // Score bonus
      function updateScoreBonusUpgrades(){while(world.score>=world.nextScoreUpgradeAt){world.pendingBonusUpgrades+=1;world.nextScoreUpgradeAt+=world.scoreUpgradeStep;} if(world.state==='playing'&&world.pendingBonusUpgrades>0){presentBonusUpgrade();}}

      // Pause
      function togglePause(){ if(world.state==='playing'){world.state='paused'; renderStats(); pauseOverlay.classList.add('show');} else if(world.state==='paused'){world.state='playing'; pauseOverlay.classList.remove('show');} }
      function renderStats(){
        const lines=[];
        const deg=(r)=>Math.round(r*57.2958);
        lines.push(['Round', world.round], ['Score', world.score], ['Kills', world.totalKills]);
        lines.push(['HP', `${Math.round(player.hp)}/${player.maxHp}`], ['Move Speed', Math.round(player.baseMoveSpeed)]);
        lines.push(['Fire Rate', player.fireRate.toFixed(2)], ['Damage', Math.round(player.bulletDamage)]);
        lines.push(['Proj Speed', Math.round(player.bulletSpeed)], ['Bullet Size', player.bulletRadius.toFixed(1)]);
        lines.push(['Pierce', player.pierceCount], ['Bounce', player.bounceCount]);
        lines.push(['Multishot', player.multiShot], ['Spread (deg)', player.spreadDeg]);
        lines.push(['Crit Chance', `${Math.round(player.critChance*100)}%`], ['Crit Mult', player.critMultiplier.toFixed(2)+'x']);
        lines.push(['Pickup Radius', Math.round(player.pickupRadius)], ['Range', `${Math.round(player.baseBulletLife*player.bulletLifeMultiplier*100)/100}s`]);
        lines.push(['Homing', `${deg(player.homingStrength)}°/s`], ['Luck', player.luckLevel]);
        lines.push(['Weapon', player.weaponType]);
        if(player.weaponType==='pistol'){lines.push(['Magazine', `${player.weapon.magazine}/${player.weapon.magazineSize}`], ['Reload', `${player.weapon.reloadTime.toFixed(2)}s`], ['Special', player.mods.pistolDoubleTap?'Double Tap':'-']);}
        if(player.weaponType==='shotgun'){lines.push(['Pellets', player.weapon.pellets], ['Spread', player.weapon.pelletSpreadDeg+'°'], ['Special', player.mods.choke?'Choke ':'' + (player.mods.doubleBarrel?'Double ':'') + (player.mods.slug?'Slug ':'') + (player.mods.shotgunKnockback?'Knockback':'')]);}
        if(player.weaponType==='katana'){lines.push(['Slash CD', `${player.weapon.katanaCooldown.toFixed(2)}s`], ['Range', player.weapon.katanaRange], ['Special', (player.mods.katanaFireLevel?'Fire ':'') + (player.mods.katanaPoisonLevel?'Poison ':'') + (player.mods.extendedReach?'Reach ':'') + (player.mods.swiftSlash?'Swift ':'') + (player.mods.katanaWhirl?'Whirl':'')]);}
        if(player.weaponType==='railgun'){lines.push(['Pierce', Math.max(8,player.pierceCount+8)], ['Special', (player.mods.railChain?'Chain ':'')]);}
        if(player.weaponType==='rocket'){lines.push(['Explosion', Math.round(80*rocketExplosionScale)], ['Special', (player.mods.rocketCluster?'Cluster ':'')]);}
        statsGrid.innerHTML=''; for(const [k,v] of lines){const row=document.createElement('div');row.innerHTML=`<span>${k}</span><span>${v}</span>`;statsGrid.appendChild(row);}
      }
      resumeBtn.addEventListener('click',()=>togglePause());

      // Enhanced enemy spawning with new types
      function startRound(){
        world.bossRoundActive=(world.round%25===0);
        if(world.bossRoundActive){spawnBoss(); roundTextEl.textContent=`Round ${world.round} (Boss)`; return;}
        const baseEnemies=5, enemiesToSpawn=Math.round(baseEnemies+world.round*2.0), enemyHp=Math.round(16+world.round*6), enemySpeed=80+world.round*6;
        const greenEnabled=world.round>=11, greenChance=greenEnabled?clamp((world.round-10)*0.05,0.15,0.5):0;
        const blueEnabled=world.round>=15, blueChance=blueEnabled?clamp((world.round-14)*0.03,0.05,0.2):0;
        const yellowEnabled=world.round>=20, yellowChance=yellowEnabled?clamp((world.round-19)*0.02,0.03,0.15):0;
        
        for(let i=0;i<enemiesToSpawn;i++){
          const side=Math.floor(Math.random()*4); let x,y;
          if(side===0){x=-20;y=randRange(0,canvas.clientHeight);} else if(side===1){x=canvas.clientWidth+20;y=randRange(0,canvas.clientHeight);} else if(side===2){x=randRange(0,canvas.clientWidth);y=-20;} else {x=randRange(0,canvas.clientWidth);y=canvas.clientHeight+20;}
          
          const roll=Math.random();
          if(yellowEnabled && roll<yellowChance){
            // Yellow: Teleporter enemy
            const hp=Math.round(enemyHp*0.8);
            enemies.push({x,y,radius:10,color:'#fbbf24',hp:hp,maxHp:hp,speed:enemySpeed*0.8,damage:20,type:'teleporter',burnTime:0,burnDps:0,poisonTime:0,poisonDps:0,teleportTimer:randRange(2,4),lastTeleport:0});
          }else if(blueEnabled && roll<yellowChance+blueChance){
            // Blue: Splitter enemy
            const hp=Math.round(enemyHp*1.2);
            enemies.push({x,y,radius:15,color:'#60a5fa',hp:hp,maxHp:hp,speed:enemySpeed*0.7,damage:18,type:'splitter',burnTime:0,burnDps:0,poisonTime:0,poisonDps:0,hasSplit:false});
          }else if(greenEnabled && roll<yellowChance+blueChance+greenChance){
            // Green: Fast enemy
            const hp=Math.round(enemyHp*0.6);
            enemies.push({x,y,radius:8,color:'#34d399',hp:hp,maxHp:hp,speed:enemySpeed*1.35,damage:12,type:'green',burnTime:0,burnDps:0,poisonTime:0,poisonDps:0});
          }else{
            // Red: Normal enemy
            enemies.push({x,y,radius:12,color:'#f87171',hp:enemyHp,maxHp:enemyHp,speed:enemySpeed,damage:16,type:'normal',burnTime:0,burnDps:0,poisonTime:0,poisonDps:0});
          }
        }
        roundTextEl.textContent=`Round ${world.round}`;
      }
      function spawnBoss(){const bossHp=world.endlessMode?2500+world.round*120:2000+world.round*100; enemies.push({x:canvas.clientWidth/2,y:-60,radius:26,color:'#a78bfa',hp:bossHp,maxHp:bossHp,speed:90,damage:28,type:'boss',burnTime:0,burnDps:0,poisonTime:0,poisonDps:0});}
      function endRound(){const finished=world.round;world.round+=1; if(finished%10===0)world.rerolls+=1; world.state='choosing';presentUpgradeChoices();}

      // Weapons select
      function selectWeapon(type){
        player.weaponType=type;
        if(type==='pistol'){player.fireRate=7;player.weapon.magazineSize=15;player.weapon.magazine=player.weapon.magazineSize;player.weapon.reloadTime=1.1;player.weapon.reloadTimer=0;player.weapon.reloading=false;player.bulletDamage=36;player.bulletSpeed=560;player.spreadDeg=6;}
        else if(type==='shotgun'){player.fireRate=1.2;player.weapon.pellets=7;player.weapon.pelletSpreadDeg=34;player.weapon.pelletLife=0.6;player.bulletDamage=10;player.bulletSpeed=520;player.spreadDeg=20;}
        else if(type==='katana'){player.weapon.katanaCooldown=0.35;player.weapon.katanaRange=86;player.weapon.katanaArcDeg=100;player.weapon.katanaDamage=42;}
        else if(type==='railgun'){player.fireRate=0.6;player.bulletDamage=120;player.bulletSpeed=1400;player.spreadDeg=2;player.pierceCount=8;}
        else if(type==='rocket'){player.fireRate=0.8;player.bulletDamage=40;player.bulletSpeed=420;player.spreadDeg=4;}
        else {player.fireRate=5;player.bulletDamage=16;player.bulletSpeed=520;player.spreadDeg=10;}
        updateHud();
      }

      // Entities
      function spawnBullet(x,y,a,overrides={}){
        const baseLife=overrides.life??player.baseBulletLife, life=baseLife*player.bulletLifeMultiplier, speed=overrides.speed??player.bulletSpeed, radius=overrides.radius??player.bulletRadius, damage=overrides.damage??player.bulletDamage, color=overrides.color??'#93c5fd';
        const explodeRadius=overrides.explodeRadius??0, explodeDamage=overrides.explodeDamage??0, homing=overrides.homing??player.homingStrength, source=overrides.source??player.weaponType;
        const vx=Math.cos(a)*speed, vy=Math.sin(a)*speed;
        bullets.push({x,y,vx,vy,radius,damage,life,color,pierceLeft:(overrides.pierce??player.pierceCount),bouncesLeft:(overrides.bounce??player.bounceCount),fireLevel:(overrides.fireLevel??player.mods.bulletFireLevel),poisonLevel:(overrides.poisonLevel??player.mods.bulletPoisonLevel),explodeRadius,explodeDamage,homing,source});
      }
      function spawnPickups(x,y,c){for(let i=0;i<c;i++){const ang=randRange(0,Math.PI*2),s=randRange(40,120);pickups.push({x,y,vx:Math.cos(ang)*s,vy:Math.sin(ang)*s,r:4,life:4,value:5});}}
      function spawnParticles(x,y,color,c=10){for(let i=0;i<c;i++){const a=randRange(0,Math.PI*2),s=randRange(40,220);particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:randRange(1,2.5),color,life:randRange(0.25,0.6)});}}
      function onEnemyKilled(e){world.totalKills+=1;world.score+=10;killsTextEl.textContent=`Kills ${world.totalKills}`;scoreTextEl.textContent=`Score ${world.score}`;spawnPickups(e.x,e.y,2);spawnParticles(e.x,e.y,'#fca5a5',16); if(onKillExplosionEnabled){const R=60,D=14+world.round*2;for(const x of enemies)if(distance({x:e.x,y:e.y},x)<=R)x.hp-=D;spawnParticles(e.x,e.y,'#fde68a',20);} updateScoreBonusUpgrades();}

      // Input
      window.addEventListener('keydown',e=>{
        const k=e.key.toLowerCase(); keysDown.add(k);
        if(k==='escape'||k==='p'){ if(!upgradeOverlay.classList.contains('show') && !gameOverOverlay.classList.contains('show')) togglePause(); return; }
        if(world.state!=='playing')return;
        if(e.code==='Space'){
          if(player.dashCooldownTimer<=0&&(keysDown.has('Space')||keysDown.has(' '))){
            player.isDashing=true;
            player.dashTime=player.dashDuration;
            player.dashCooldownTimer=player.dashCooldown;
            playDashSound();
            spawnParticles(player.x,player.y,'#60a5fa',22);
            if(player.weaponType==='katana'&&player.mods.katanaWhirl){
              const r=80,d=30;
              for(const en of enemies){
                if(distance(player,en)<=r+en.radius)en.hp-=d;
              }
              spawnParticles(player.x,player.y,'#a7f3d0',28);
            }
          }
          e.preventDefault();
        }
        // Special abilities
        if(k==='q'&&player.specialCooldown<=0){
          activateSpecialAbility();
        }
      });
      window.addEventListener('keyup',e=>{keysDown.delete(e.key.toLowerCase());});
      restartBtn.addEventListener('click',()=>{gameOverOverlay.classList.remove('show');resetGame();});
      continueBtn.addEventListener('click',()=>{gameOverOverlay.classList.remove('show');world.state='playing';world.endlessMode=true;world.round+=1;startRound();});

      // Special abilities system
      function activateSpecialAbility(){
        if(player.specialAbility==='none'||player.specialCooldown>0)return;
        
        switch(player.specialAbility){
          case 'shield':
            player.invulnTime=3.0;
            player.specialCooldown=15;
            spawnParticles(player.x,player.y,'#3b82f6',30);
            playSpecialAbilitySound('shield');
            break;
          case 'timeFreeze':
            setTimeScale(0.2,3.0);
            player.specialCooldown=20;
            spawnParticles(player.x,player.y,'#8b5cf6',40);
            playSpecialAbilitySound('timeFreeze');
            break;
          case 'energyBlast':
            const blastRadius=150;
            for(const e of enemies){
              const dist=distance(player,e);
              if(dist<=blastRadius){
                e.hp-=80;
                const pushForce=30;
                const dx=e.x-player.x,dy=e.y-player.y,len=Math.hypot(dx,dy)||1;
                e.x+=dx/len*pushForce;e.y+=dy/len*pushForce;
              }
            }
            player.specialCooldown=18;
            spawnParticles(player.x,player.y,'#f59e0b',50);
            addScreenShake(15);
            playSpecialAbilitySound('energyBlast');
            break;
          case 'heal':
            player.hp=Math.min(player.maxHp,player.hp+40);
            player.specialCooldown=25;
            spawnParticles(player.x,player.y,'#10b981',25);
            playSpecialAbilitySound('heal');
            break;
        }
      }
      
      // Combat helpers
      function aimFromArrows(){const r=keysDown.has('arrowright'),l=keysDown.has('arrowleft'),d=keysDown.has('arrowdown'),u=keysDown.has('arrowup');let ax=(r?1:0)-(l?1:0),ay=(d?1:0)-(u?1:0);const len=Math.hypot(ax,ay);if(!len)return null;return{angle:Math.atan2(ay,ax)};}
      function tryShoot(angle){
        const multiPenalty=1+0.15*player.multiShot; let base=player.fireRate; if(player.weaponType==='shotgun'&&player.mods.doubleBarrel)base*=0.8; const cd=(1/base)*multiPenalty;
        if(player.weaponType==='katana'){if(player.weapon.katanaCooldownTimer>0)return false; performSlash(angle); player.weapon.katanaCooldownTimer=player.weapon.katanaCooldown; return true;}
        if(player.fireCooldown>0)return false;
        if(player.weaponType==='pistol'){
          if(player.weapon.reloading)return false; if(player.weapon.magazine<=0){startReload();return false;}
          fireMulti(angle,{color:'#22d3ee'}); if(player.mods.pistolDoubleTap && Math.random()<0.25) fireMulti(angle,{color:'#22d3ee'});
          player.weapon.magazine-=1; player.fireCooldown=cd; return true;
        }
        if(player.weaponType==='shotgun'){
          const n=player.weapon.pellets,deg=player.weapon.pelletSpreadDeg,rad=(deg*Math.PI)/180,baseA=angle-rad*0.5;
          for(let i=0;i<n;i++){const t=n>1?i/(n-1):0.5; const a=baseA+t*rad+randRange(-0.04,0.04); spawnBullet(player.x,player.y,a,{life:player.weapon.pelletLife,damage:player.bulletDamage,color:'#f59e0b'});}
          player.fireCooldown=cd; return true;
        }
        if(player.weaponType==='railgun'){spawnBullet(player.x,player.y,angle,{speed:player.bulletSpeed,damage:player.bulletDamage,pierce:Math.max(8,player.pierceCount+8),radius:12,life:1.2,color:'#a78bfa',source:'railgun'}); player.fireCooldown=cd; return true;}
        if(player.weaponType==='rocket'){const R=80*rocketExplosionScale,D=90*rocketExplosionScale; spawnBullet(player.x,player.y,angle,{speed:player.bulletSpeed,damage:player.bulletDamage,radius:6,life:2.0,color:'#ef4444',explodeRadius:R,explodeDamage:D,source:'rocket'}); player.fireCooldown=cd; return true;}
        fireMulti(angle,{color:'#93c5fd'}); player.fireCooldown=cd; return true;
      }
      function fireMulti(angle,ov){const n=1+player.multiShot; if(n<=1){spawnBullet(player.x,player.y,angle,ov);return;} const s=(player.spreadDeg*Math.PI)/180,base=angle-s*(n-1)/2; for(let i=0;i<n;i++)spawnBullet(player.x,player.y,base+s*i,ov);}
      function startReload(){player.weapon.reloading=true;player.weapon.reloadTimer=player.weapon.reloadTime;}
      function performSlash(angle){const range=player.weapon.katanaRange, arc=(player.weapon.katanaArcDeg*Math.PI)/180, half=arc/2, dmg=player.weapon.katanaDamage; for(let i=0;i<18;i++){const t=i/17,a=angle-half+t*arc,r=range*(0.6+0.4*Math.random());particles.push({x:player.x+Math.cos(a)*r,y:player.y+Math.sin(a)*r,vx:0,vy:0,r:2,color:'#a7f3d0',life:0.2});} for(const e of enemies){const d=distance(player,e); if(d>range+e.radius)continue; const dir=angleBetween(player,e),diff=Math.abs(wrapAngle(dir-angle)); if(diff<=half){e.hp-=dmg;spawnParticles(e.x,e.y,'#bbf7d0',6); if(player.mods.katanaFireLevel>0){e.burnTime=Math.max(e.burnTime,2.5+0.6*(player.mods.katanaFireLevel-1));e.burnDps=Math.max(e.burnDps,10*player.mods.katanaFireLevel);} if(player.mods.katanaPoisonLevel>0){e.poisonTime=Math.max(e.poisonTime,3+0.6*(player.mods.katanaPoisonLevel-1));e.poisonDps=Math.max(e.poisonDps,8*player.mods.katanaPoisonLevel);}}}}

      // Update & draw
      let last=performance.now();
      function update(dt){
        world.time+=dt;
        if(world.state!=='playing')return;

        // Movement
        const ix=(keysDown.has('d')?1:0)-(keysDown.has('a')?1:0), iy=(keysDown.has('s')?1:0)-(keysDown.has('w')?1:0), len=Math.hypot(ix,iy)||1, speed=player.isDashing?player.dashSpeed:player.baseMoveSpeed;
        player.velocityX=(ix/len)*speed; player.velocityY=(iy/len)*speed; player.x=clamp(player.x+player.velocityX*dt,player.radius,canvas.clientWidth-player.radius); player.y=clamp(player.y+player.velocityY*dt,player.radius,canvas.clientHeight-player.radius);
        if(player.isDashing){player.dashTime-=dt; if(player.dashTime<=0)player.isDashing=false;} else {player.dashCooldownTimer=Math.max(0,player.dashCooldownTimer-dt);}

        // Reload & katana cooldown & special ability cooldown
        if(player.weapon.reloading){player.weapon.reloadTimer-=dt; if(player.weapon.reloadTimer<=0){player.weapon.reloading=false;player.weapon.magazine=player.weapon.magazineSize;}}
        if(player.weapon.katanaCooldownTimer>0)player.weapon.katanaCooldownTimer-=dt;
        if(player.specialCooldown>0)player.specialCooldown-=dt;

        // Shooting
        player.fireCooldown-=dt; const aim=aimFromArrows(); if(aim)tryShoot(aim.angle);

        // Bullets
        for(let i=bullets.length-1;i>=0;i--){
          const b=bullets[i];
          // Homing
          if(b.homing>0&&enemies.length>0){let near=null,nd=1e9; for(const e of enemies){const d=Math.hypot(e.x-b.x,e.y-b.y); if(d<nd){nd=d;near=e;}} if(near){const desired=Math.atan2(near.y-b.y,near.x-b.x),cur=Math.atan2(b.vy,b.vx); let dAng=wrapAngle(desired-cur); const max=b.homing*dt; dAng=clamp(dAng,-max,max); const sp=Math.hypot(b.vx,b.vy); const na=cur+dAng; b.vx=Math.cos(na)*sp; b.vy=Math.sin(na)*sp;}}
          b.x+=b.vx*dt; b.y+=b.vy*dt; b.life-=dt;
          let bounced=false;
          if(b.x<b.radius&&b.vx<0){if(b.bouncesLeft>0){b.vx*=-1;b.x=b.radius;b.bouncesLeft--;bounced=true;}}
          if(b.x>canvas.clientWidth-b.radius&&b.vx>0){if(b.bouncesLeft>0){b.vx*=-1;b.x=canvas.clientWidth-b.radius;b.bouncesLeft--;bounced=true;}}
          if(b.y<b.radius&&b.vy<0){if(b.bouncesLeft>0){b.vy*=-1;b.y=b.radius;b.bouncesLeft--;bounced=true;}}
          if(b.y>canvas.clientHeight-b.radius&&b.vy>0){if(b.bouncesLeft>0){b.vy*=-1;b.y=canvas.clientHeight-b.radius;b.bouncesLeft--;bounced=true;}}
          if(bounced)spawnParticles(b.x,b.y,'#93c5fd',4);
          if(b.life<=0){bullets.splice(i,1);continue;}
          // Collide
          let exploded=false;
          for(let ei=enemies.length-1;ei>=0;ei--){
            const e=enemies[ei]; const d=Math.hypot(b.x-e.x,b.y-e.y);
            if(d<=b.radius+e.radius){
              if(b.explodeRadius>0&&!exploded){
                const R=b.explodeRadius,D=b.explodeDamage;
                for(const e2 of enemies){const de=Math.hypot(e2.x-b.x,e2.y-b.y); if(de<=R)e2.hp-=D;}
                spawnParticles(b.x,b.y,'#fb923c',28);
                if(player.mods.rocketCluster && b.source==='rocket'){
                  for(let k=0;k<4;k++){const ang=Math.PI*0.5*k, sx=b.x+Math.cos(ang)*20, sy=b.y+Math.sin(ang)*20;
                    for(const e2 of enemies){const de=Math.hypot(e2.x-sx,e2.y-sy); if(de<=R*0.5)e2.hp-=D*0.5;}
                    spawnParticles(sx,sy,'#fb923c',12);
                  }
                }
                exploded=true;
              }
              let dmg=b.damage; if(Math.random()<player.critChance){dmg*=player.critMultiplier;spawnParticles(e.x,e.y,'#fde68a',6);} e.hp-=dmg;
              if(b.fireLevel>0){e.burnTime=Math.max(e.burnTime,2.5+0.6*(b.fireLevel-1));e.burnDps=Math.max(e.burnDps,6*b.fireLevel);}
              if(b.poisonLevel>0){e.poisonTime=Math.max(e.poisonTime,3.0+0.6*(b.poisonLevel-1));e.poisonDps=Math.max(e.poisonDps,5*b.poisonLevel);}
              if(player.weaponType==='shotgun'&&player.mods.shotgunKnockback){const push=12,lenv=Math.hypot(b.vx,b.vy)||1; e.x+=(b.vx/lenv)*push; e.y+=(b.vy/lenv)*push;}
              if(player.weaponType==='railgun'&&player.mods.railChain&&b.source==='railgun'){let chains=0;for(const e2 of enemies){if(e2===e)continue;const d2=Math.hypot(e2.x-e.x,e2.y-e.y);if(d2<=140){e2.hp-=dmg*0.4;chains++;if(chains>=3)break;}}}
              if(b.pierceLeft>0)b.pierceLeft-=1; else bullets.splice(i,1);
              spawnParticles(e.x,e.y,'#fecaca',4);
              playHitSound();
              if(e.hp<=0){playEnemyDeathSound(e.type||'normal');onEnemyKilled(e);enemies.splice(ei,1);}
              break;
            }
          }
        }

        // Enhanced enemy behaviors
        for(let i=enemies.length-1;i>=0;i--){
          const e=enemies[i], dx=player.x-e.x, dy=player.y-e.y, dist=Math.hypot(dx,dy)||1;
          
          // Special enemy behaviors
          if(e.type==='teleporter'){
            e.teleportTimer-=dt;
            if(e.teleportTimer<=0 && dist>100){
              // Teleport closer to player with particles
              const angle=Math.random()*Math.PI*2;
              const teleportDist=randRange(80,120);
              e.x=clamp(player.x+Math.cos(angle)*teleportDist, e.radius, canvas.clientWidth-e.radius);
              e.y=clamp(player.y+Math.sin(angle)*teleportDist, e.radius, canvas.clientHeight-e.radius);
              spawnParticles(e.x,e.y,'#fbbf24',15);
              addScreenShake(4);
              e.teleportTimer=randRange(3,5);
            }
          }else if(e.type==='splitter' && !e.hasSplit && e.hp<=e.maxHp*0.3){
            // Split into smaller enemies when low health
            e.hasSplit=true;
            for(let j=0;j<3;j++){
              const angle=j*Math.PI*2/3;
              const newX=e.x+Math.cos(angle)*20;
              const newY=e.y+Math.sin(angle)*20;
              enemies.push({
                x:clamp(newX,8,canvas.clientWidth-8),
                y:clamp(newY,8,canvas.clientHeight-8),
                radius:6,color:'#93c5fd',hp:e.hp*0.4,maxHp:e.hp*0.4,
                speed:e.speed*1.5,damage:8,type:'mini',
                burnTime:0,burnDps:0,poisonTime:0,poisonDps:0
              });
            }
            spawnParticles(e.x,e.y,'#60a5fa',20);
            addScreenShake(6);
          }
          
          // Normal movement
          e.x+=(dx/dist)*e.speed*dt; e.y+=(dy/dist)*e.speed*dt;
          
          // Status effects
          if(e.burnTime>0){e.burnTime-=dt; e.hp-=e.burnDps*dt; if(Math.random()<0.1)spawnParticles(e.x,e.y,'#f59e0b',2);}
          if(e.poisonTime>0){e.poisonTime-=dt; e.hp-=e.poisonDps*dt; if(Math.random()<0.1)spawnParticles(e.x,e.y,'#34d399',2);}
          
          // Player collision with invulnerability frames
          const touch=e.radius+player.radius;
          if(Math.hypot(player.x-e.x,player.y-e.y)<touch && player.invulnTime<=0){
            player.hp-=e.damage*0.5; // Reduced damage by 50%
            player.invulnTime=0.5; // Half second invulnerability
            addScreenShake(12);
            setTimeScale(0.3,0.2); // Slow motion on hit
            spawnParticles(player.x,player.y,'#ef4444',12);
            if(player.hp<=0){
              player.hp=0;updateHud(); world.state='gameover';
              continueBtn.classList.add('hidden'); gameOverTitle.textContent='You were defeated'; finalStats.textContent=`Reached Round ${world.round} · Kills ${world.totalKills} · Score ${world.score}`; gameOverOverlay.classList.add('show'); return;
            }
          }
          if(e.hp<=0){
            // Enhanced death effects
            if(e.type==='splitter'){
              spawnParticles(e.x,e.y,'#60a5fa',25);
              addScreenShake(8);
              playEnemyDeathSound('splitter');
            }else if(e.type==='teleporter'){
              spawnParticles(e.x,e.y,'#fbbf24',20);
              addScreenShake(6);
              playEnemyDeathSound('teleporter');
            }else if(e.type==='boss'){
              spawnParticles(e.x,e.y,'#a78bfa',40);
              addScreenShake(20);
              setTimeScale(0.1,1.0);
              playEnemyDeathSound('boss');
            }else{
              playEnemyDeathSound('normal');
            }
            onEnemyKilled(e);enemies.splice(i,1);
          }
        }
        
        // Player invulnerability timer
        if(player.invulnTime>0)player.invulnTime-=dt;
        // Enemy separation
        for(let i=0;i<enemies.length;i++){for(let j=i+1;j<enemies.length;j++){const a=enemies[i],b=enemies[j],dx=b.x-a.x,dy=b.y-a.y;let dist=Math.hypot(dx,dy);const min=a.radius+b.radius;if(dist===0)dist=0.001;if(dist<min){const over=(min-dist)*0.5,nx=dx/dist,ny=dy/dist;a.x-=nx*over;a.y-=ny*over;b.x+=nx*over;b.y+=ny*over;a.x=clamp(a.x,a.radius,canvas.clientWidth-a.radius);a.y=clamp(a.y,a.radius,canvas.clientHeight-a.radius);b.x=clamp(b.x,b.radius,canvas.clientWidth-b.radius);b.y=clamp(b.y,b.radius,canvas.clientHeight-b.radius);}}}

        // Pickups
        for(let i=pickups.length-1;i>=0;i--){const p=pickups[i]; p.vx*=0.98;p.vy*=0.98; const d=distance(p,player); if(d<player.pickupRadius){p.vx+=(player.x-p.x)*6*dt;p.vy+=(player.y-p.y)*6*dt;} p.x+=p.vx*dt;p.y+=p.vy*dt;p.life-=dt; if(distance(p,player)<player.radius+p.r+4){world.score+=p.value;scoreTextEl.textContent=`Score ${world.score}`;playPickupSound();pickups.splice(i,1);updateScoreBonusUpgrades();continue;} if(p.life<=0)pickups.splice(i,1);}
        // Particles
        for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.vx*=0.98;p.vy*=0.98;p.x+=p.vx*dt;p.y+=p.vy*dt;p.life-=dt;if(p.life<=0)particles.splice(i,1);}
        // End of round
        if(enemies.length===0){
          if(world.bossRoundActive){
            world.score+=world.endlessMode?(2000+world.round*20):(1500+world.round*20);scoreTextEl.textContent=`Score ${world.score}`;updateScoreBonusUpgrades();
            world.state='victory'; continueBtn.classList.remove('hidden'); gameOverTitle.textContent='Victory!'; finalStats.textContent=`Boss defeated at Round ${world.round} · Score ${world.score}`; gameOverOverlay.classList.add('show');
          } else endRound();
        }
        updateHud();
      }

      function updateHud(){
        const hpPct=clamp(player.hp/player.maxHp,0,1); 
        hpFillEl.style.width=`${Math.round(hpPct*100)}%`; 
        hpTextEl.textContent=`${Math.round(player.hp)}/${player.maxHp}`; 
        weaponTextEl.textContent=`Weapon: ${player.weaponType[0].toUpperCase()+player.weaponType.slice(1)}`;
        
        // Special ability display
        if(player.specialAbility!=='none'){
          const abilityName = player.specialAbility[0].toUpperCase() + player.specialAbility.slice(1);
          const cooldownText = player.specialCooldown > 0 ? ` (${Math.ceil(player.specialCooldown)}s)` : ' (Ready)';
          weaponTextEl.textContent += ` | Special: ${abilityName}${cooldownText}`;
        }
        
        if(player.weaponType==='pistol'){
          ammoTextEl.textContent=player.weapon.reloading?`Reloading...`:`Ammo: ${player.weapon.magazine}/${player.weapon.magazineSize}`; 
          ammoTextEl.classList.remove('hidden');
        } else ammoTextEl.classList.add('hidden');
      }

      function draw(){
        // Screen shake effect
        ctx.save();
        if(world.screenShake>0){
          const shakeX=randRange(-world.screenShake,world.screenShake);
          const shakeY=randRange(-world.screenShake,world.screenShake);
          ctx.translate(shakeX,shakeY);
          world.screenShake*=0.9; // Decay shake
          if(world.screenShake<0.1)world.screenShake=0;
        }
        
        ctx.clearRect(-50,-50,canvas.clientWidth+100,canvas.clientHeight+100);
        
        // Enhanced grid with subtle animation
        ctx.save();ctx.globalAlpha=.06;ctx.strokeStyle='#93a4b833';const g=48;const offset=world.time*10%g;
        for(let x=-offset;x<canvas.clientWidth+g;x+=g){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.clientHeight);ctx.stroke();}
        for(let y=-offset;y<canvas.clientHeight+g;y+=g){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.clientWidth,y);ctx.stroke();}ctx.restore();
        
        // Bullet trails
        for(const b of bullets){
          if(b.source==='railgun'){
            ctx.save();ctx.globalAlpha=0.3;ctx.strokeStyle=b.color;ctx.lineWidth=b.radius*1.5;ctx.lineCap='round';
            const trailLength=Math.hypot(b.vx,b.vy)*0.1;
            ctx.beginPath();ctx.moveTo(b.x,b.y);ctx.lineTo(b.x-b.vx*trailLength,b.y-b.vy*trailLength);ctx.stroke();ctx.restore();
          }
        }
        
        // Enhanced pickups with glow
        for(const p of pickups){
          ctx.save();ctx.globalAlpha=0.3;ctx.fillStyle='#fde68a';ctx.beginPath();ctx.arc(p.x,p.y,p.r*2,0,Math.PI*2);ctx.fill();ctx.restore();
          ctx.fillStyle='#fde68a';ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();
        }
        
        // Enhanced particles
        for(const p of particles){
          ctx.globalAlpha=clamp(p.life,0,1);ctx.fillStyle=p.color;
          ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();
          // Glow effect for certain particles
          if(p.color.includes('#f59e0b')||p.color.includes('#34d399')){
            ctx.globalAlpha=clamp(p.life*0.2,0,0.2);ctx.beginPath();ctx.arc(p.x,p.y,p.r*3,0,Math.PI*2);ctx.fill();
          }
          ctx.globalAlpha=1;
        }
        
        // Enhanced bullets with glow
        for(const b of bullets){
          // Glow effect
          ctx.save();ctx.globalAlpha=0.4;ctx.fillStyle=b.color||'#93c5fd';
          ctx.beginPath();ctx.arc(b.x,b.y,b.radius*1.8,0,Math.PI*2);ctx.fill();ctx.restore();
          // Main bullet
          ctx.fillStyle=b.color||'#93c5fd';ctx.beginPath();ctx.arc(b.x,b.y,b.radius,0,Math.PI*2);ctx.fill();
        }
        
        // Enhanced enemies with better visual effects
        for(const e of enemies){
          // Enemy glow based on type
          if(e.type==='teleporter'){
            ctx.save();ctx.globalAlpha=0.3;ctx.fillStyle='#fbbf24';
            ctx.beginPath();ctx.arc(e.x,e.y,e.radius*1.5,0,Math.PI*2);ctx.fill();ctx.restore();
          }else if(e.type==='splitter'){
            ctx.save();ctx.globalAlpha=0.2;ctx.fillStyle='#60a5fa';
            ctx.beginPath();ctx.arc(e.x,e.y,e.radius*1.3,0,Math.PI*2);ctx.fill();ctx.restore();
          }else if(e.type==='boss'){
            ctx.save();ctx.globalAlpha=0.4;ctx.fillStyle='#a78bfa';
            ctx.beginPath();ctx.arc(e.x,e.y,e.radius*1.4,0,Math.PI*2);ctx.fill();ctx.restore();
          }
          
          // Main enemy body
          ctx.fillStyle=e.color;ctx.beginPath();ctx.arc(e.x,e.y,e.radius,0,Math.PI*2);ctx.fill();
          
          // Health bar
          ctx.strokeStyle='#fecaca';ctx.lineWidth=2;const pct=clamp(e.hp/e.maxHp,0,1);
          ctx.beginPath();ctx.arc(e.x,e.y,e.radius+4,-Math.PI/2,-Math.PI/2+pct*Math.PI*2);ctx.stroke();
          
          // Status effect indicators
          if(e.burnTime>0){
            ctx.globalAlpha=.4+Math.sin(world.time*8)*0.2;ctx.strokeStyle='#f59e0b';ctx.lineWidth=3;
            ctx.beginPath();ctx.arc(e.x,e.y,e.radius+8,0,Math.PI*2);ctx.stroke();ctx.globalAlpha=1;
          }
          if(e.poisonTime>0){
            ctx.globalAlpha=.4+Math.sin(world.time*6)*0.2;ctx.strokeStyle='#34d399';ctx.lineWidth=3;
            ctx.beginPath();ctx.arc(e.x,e.y,e.radius+12,0,Math.PI*2);ctx.stroke();ctx.globalAlpha=1;
          }
        }
        
        // Enhanced player with invulnerability flash
        if(player.invulnTime>0 && Math.sin(world.time*20)>0){
          ctx.globalAlpha=0.5;
        }
        // Player glow
        ctx.save();ctx.globalAlpha=0.3;ctx.fillStyle=player.color;
        ctx.beginPath();ctx.arc(player.x,player.y,player.radius*1.6,0,Math.PI*2);ctx.fill();ctx.restore();
        // Main player
        ctx.fillStyle=player.color;ctx.beginPath();ctx.arc(player.x,player.y,player.radius,0,Math.PI*2);ctx.fill();
        ctx.globalAlpha=1;
        
        // Round cleared text
        if(world.state==='choosing'){
          ctx.fillStyle='#e6edf3';ctx.font='600 22px Inter, system-ui, sans-serif';
          ctx.fillText(`Round ${world.round-1} cleared`,20,canvas.clientHeight-24);
        }
        
        ctx.restore();
      }

      function loop(now){const dt=clamp((now-last)/1000,0,0.05);last=now;update(dt);draw();requestAnimationFrame(loop);} requestAnimationFrame(loop);
      resetGame();
    </script>
  </body>
  </html>